<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Twitch Bot</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/socket.io@4.0.1/dist/socket.io.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <h2>Twitch Bot Text Sender</h2>

    {% if not has_token %}
      <!-- Step 1: user needs to connect their Twitch account -->
      <button
        id="fetchTokenBtn"
        class="btn btn-primary mb-3"
      >Connect Twitch Account</button>
    {% else %}
      <!-- Step 2: user already has tokens -->
      <button
        id="startBotBtn"
        class="btn btn-success me-2 mb-3"
      >Start Bot</button>
      <button
        id="stopBotBtn"
        class="btn btn-danger mb-3"
      >Stop Bot</button>
    {% endif %}

    <!-- Log output -->
    <div
      id="botLogs"
      class="mt-4 p-3 bg-light border"
      style="height: 400px; overflow-y: auto;"
    ></div>

    <!-- List of existing CSV files -->
    <h2 class="mt-4">Existing Files:</h2>
    <ul>
      {% for file in files %}
        <li>
          <a href="{{ url_for('static', filename=file) }}" download>
            {{ file }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // 1) Socket.IO listener
      const socket = io();
      const logContainer = document.getElementById("botLogs");
      socket.on("bot_log_update", data => {
        logContainer.innerHTML += `<p>${data.log}</p>`;
        logContainer.scrollTop = logContainer.scrollHeight;
      });

      // 2) Helper to POST and alert on message/error
      function doRequest(path) {
        fetch(path, { method: "POST" })
          .then(res => res.json())
          .then(data => {
            if (data.error)   alert("Error: " + data.error);
            else if (data.message) alert(data.message);
            else alert("Unexpected response from server.");
          })
          .catch(err => {
            console.error("Request failed:", err);
            alert("Network error");
          });
      }

      // 3) Wire up Start/Stop buttons (if present)
      const startBtn = document.getElementById("startBotBtn");
      if (startBtn) {
        startBtn.addEventListener("click", () => doRequest("/run_bot"));
      }

      const stopBtn = document.getElementById("stopBotBtn");
      if (stopBtn) {
        stopBtn.addEventListener("click", () => doRequest("/stop_bot"));
      }

      // 4) Wire up OAuth “Connect” button (if present)
      const fetchBtn = document.getElementById("fetchTokenBtn");
      if (fetchBtn) {
        fetchBtn.addEventListener("click", () => {
          // redirect the browser into your /act → Twitch flow
          window.location.href = "/act";
        });
      }
    });
  </script>
</body>
</html>
